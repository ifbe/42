<html>
<head>
<style>
html,body{margin:0;padding:0;overflow:hidden;}
#haha {
	white-space:pre-wrap;
	white-space:-moz-pre-wrap;
	white-space:-pre-wrap;
	white-space:-o-pre-wrap;
	word-wrap:break-word;
}
#debug {
	position:absolute;
	left:0%;
	top:0%;
	width:100%;
	height:100%;
	background:#000;
	color:#fff;
	overflow-y:scroll;
}
#boxroot {
	position:absolute;
	left:4%;
	top:4%;
	width:90%;
	height:90%;
	box-shadow:2px 2px 4px #eee;
	opacity:0.8;
}
#boxhead {
	width:100%;
	height:2%;
	background: #ccc;
	border-bottom: 1px solid #eee;
	border-radius: 4px 4px 0 0;
}
#boxlogin {
	position:absolute;
	width:100%;
	height:98%;
	background:#444;
	color:#fff;
	font-size:128px;
	text-align:center;
}
#boxerror {
	position:absolute;
	width:100%;
	height:98%;
	background:#444;
	color:#fff;
	font-size:128px;
	text-align:center;
}
#boxdraw {
	position:absolute;
	width:100%;
	height:98%;
	background:#444;
	color:#fff;
	text-align:center;
}
#boxpixel {
	position:absolute;
	width:100%;
	height:98%;
	background:#444;
	color:#fff;
	text-align:center;
}
</style>
<script type="text/javascript">
function say(data)
{
	var debug=document.getElementById("debug");
	debug.textContent=debug.textContent+data+"\n";
	debug.scrollTop=debug.scrollHeight;
}
function showlogin()
{
	document.getElementById('boxlogin').style.display="";
	document.getElementById('boxerror').style.display="none";
	document.getElementById('boxdraw').style.display="none";
	document.getElementById('boxpixel').style.display="none";
}
function showerror()
{
	document.getElementById('boxlogin').style.display="none";
	document.getElementById('boxerror').style.display="";
	document.getElementById('boxdraw').style.display="none";
	document.getElementById('boxpixel').style.display="none";
}
function showdraw(data)
{
	say("string "+data.length);
	document.getElementById('boxlogin').style.display="none";
	document.getElementById('boxerror').style.display="none";
	document.getElementById('boxdraw').style.display="";
	document.getElementById('boxpixel').style.display="none";

	document.getElementById('boxdraw').innerHTML=data;
}
function showpixel(data)
{
	var ctx = document.getElementById('pixel').getContext('2d');
	var imageData = ctx.createImageData(512, 512);
	var p = imageData.data;

	say("binary "+data.byteLength);
	document.getElementById('boxlogin').style.display="none";
	document.getElementById('boxerror').style.display="none";
	document.getElementById('boxdraw').style.display="none";
	document.getElementById('boxpixel').style.display="";

	for (var y=0;y<512;y++) {
		for (var x=0;x<512;x++) {
			p[4*(512*y+x)+0] = x;
			p[4*(512*y+x)+1] = y;
			p[4*(512*y+x)+2] = 99;
			p[4*(512*y+x)+3] = 255;
		}
	}
	//var buf = new ArrayBuffer(imageData.data.length);
	//var buf8 = new Uint8ClampedArray(buf);
	//var data = new Uint32Array(buf);
	//data[y*width + x] =(255<<24)|(value<<16)|(value<<8)|value;
	//imageData.data.set(buf8);
	ctx.putImageData(imageData, 0, 0);
}

var ws=new WebSocket("ws://127.0.0.1:2222");
ws.binaryType = 'arraybuffer';
function send(data)
{
	say(data);
	if(ws.readyState == WebSocket.OPEN)
	{
		ws.send(data);
	}
}
function sendbin(data)
{
	//var bin = new Uint8Array(1024*1024*3);
	//for (var i = 0; i < 1024*1024; i+=3) {
		//do something
	//}
	//ws.send(bin.buffer);
}
function sendblob(data)
{
	//var file = document.querySelector('input[type="file"]').files[0];
	//ws.send(file);
}
ws.onmessage=function(event)
{
	if(typeof event.data === "string")
	{
		showdraw(event.data);
	}
	else //if(event.data instanceof ArrayBuffer)
	{
		showpixel(event.data);
	}
};
ws.onopen=function(event)
{
	say("welcome victim");
};
ws.onclose=function(event)
{
	say("connection closed");
	showerror();
};
ws.onerror=function(event)
{
	say("something wrong");
	showerror();
};

var oldw=0;
var oldh=0;
window.onresize=function(){  
	var w = window.innerWidth
	|| document.documentElement.clientWidth
	|| document.body.clientWidth;

	var h = window.innerHeight
	|| document.documentElement.clientHeight
	|| document.body.clientHeight;

	if((w!=oldw)&&(h!=oldh))
	{
		send("size "+w+","+h);

		oldw=w;
		oldh=h;
	}
}
window.onkeydown=function(ev){
	var k=ev.keyCode;
	if((k==8)||(k==9))
	{
		ev.preventDefault();
		send("char "+k);
	}
	else if(k==13||k==32||(k>=48&&k<=57))
	{
		send("char "+k);
	}
	else if(k>=65&&k<=90)
	{
		k=k+32;
		send("char "+k);
	}
	else
	{
		send("kbd "+k);
	}
}

window.onload=function() {
	var boxroot=document.getElementById("boxroot");

	var boxhead=document.getElementById("boxhead");
	var draging=false;
	var disX = disY = 0;

	var boxdraw=document.getElementById("boxdraw");
	var lastmousex = lastmousey = -99;

	boxhead.onmousedown=function(event)
	{
		draging=true;
		disX=event.clientX-boxroot.offsetLeft;
		disY=event.clientY-boxroot.offsetTop;
		document.onmousemove = function(event)
		{
			if(!draging)return;
			document.body.style.cursor = "move";
			var event = event || window.event;
			var boxX = event.clientX - disX;
			var boxY = event.clientY - disY;
			var maxX = document.body.scrollWidth - boxroot.offsetWidth;
			var maxY = document.body.offsetHeight - boxroot.offsetHeight;
			//boxX = (boxX < 0) ? 0 : boxX;
			boxY = (boxY < 0) ? 0 : boxY;
			//boxX = (boxX > maxX) ? maxX : boxX;
			//boxY = (boxY > maxY) ? maxY : boxY;
			boxroot.style.left = boxX + "px";
			boxroot.style.top = boxY + "px";
		};
         
		document.onmouseup = function()
		{
			draging = false;
			document.body.style.cursor = "";
		};
	}

	boxdraw.onmouseenter=function(event)
	{
		//document.getElementById("boxroot").style.opacity=0.8;
	}
	boxdraw.onmouseleave=function(event)
	{
		//document.getElementById("boxroot").style.opacity=0.4;
	}
	boxdraw.onmousedown=function(event)
	{
		var x = event.clientX -boxroot.offsetLeft;
		var y = event.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		say("mousestart "+x+" "+y);
	}
	boxdraw.onmouseup=function(event)
	{
		var x = event.clientX -boxroot.offsetLeft;
		var y = event.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		say("mouseend "+x+" "+y);
	}
	boxdraw.onmousemove=function(event)
	{
		var x = event.clientX -boxroot.offsetLeft;
		var y = event.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		if((x==lastmousex)&&(y==lastmousey))return;

		lastmousex=x;
		lastmousey=y;
		say("mousemove "+x+" "+y);
	}

	boxdraw.ontouchstart=function(event)
	{
		event.preventDefault();
		var touch0 = event.touches[0];
		var x = touch0.clientX -boxroot.offsetLeft;
		var y = touch0.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		say("touchatart "+x+" "+y);
	}
	boxdraw.ontouchmove=function(event)
	{
		event.preventDefault();
		var touch0 = event.touches[0];
		var x = touch0.clientX -boxroot.offsetLeft;
		var y = touch0.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		say("touchmove "+x+" "+y);
	}
	boxdraw.ontouchend=function(event)
	{
		event.preventDefault();
		var touch0 = event.touches[0];
		var x = touch0.clientX -boxroot.offsetLeft;
		var y = touch0.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		say("touchend "+x+" "+y);
	}
	boxdraw.ontouchcancel=function(event)
	{
		event.preventDefault();
		var touch0 = event.touches[0];
		var x = touch0.clientX -boxroot.offsetLeft;
		var y = touch0.clientY -boxroot.offsetTop -boxdraw.offsetTop;
		say("touchcancel "+x+" "+y);
	}
}

var canvas = document.createElement('canvas');
canvas.height = 1024;
canvas.width = 1024;
var ctx = canvas.getContext('2d');

</script>
</head>

<body>
<pre id="haha">
	<code id="debug">
	</code>
</pre>
<div id="boxroot">
	<div id="boxhead">
	</div>

	<div id="boxlogin">
		<form action="form_action.asp" method="get">
		username:<input type="text" name="fname" /><br />
		password:<input type="text" name="lname" /><br />
		<input type="submit" value="play" />
		<input type="submit" value="look" />
		</form>
	</div>

	<div id="boxerror">
		error!
	</div>

	<div id="boxdraw">
		haha
	</div>

	<div id="boxpixel">
		<canvas id="pixel" width="512" height="512">
		</canvas>
	</div>
</div>
</body>
</html>
